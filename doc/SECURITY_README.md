# SECURITY API

## get_certificate

```javascript
String get_certificate(String cert_id)
```

**Description**

Return the certificate stored in the Secure Element in PEM format

**Parameters**

*String*: Certificate identifier. Must be **artik** or **manufacturer**

**Return value**

*String*: PEM certificate or error information

**Example**

```javascript
console.log(get_certificate('artik'))
```

## get_ca_chain

```javascript
String get_ca_chain(String cert_id)
```

**Description**

Return the Certificate Authority chain of the device in PEM format.
It contains one or more certificates used for verifying the device
certificate stored in the SE.

**Parameters**

*String*: Certificate identifier. Must be **artik** or **manufacturer**

**Return value**

*String*: PEM certificate(s) or error information

**Example**

```javascript
console.log(get_ca_chain('artik'))
```

## get_key_from_cert

```javascript
String get_key_from_cert(String certificate)
```

**Description**

Return the private key matching the certificate passed
as a parameter. The return string is in PEM format.

**Parameters**

*String*: PEM certificate from which to extract the private key.

**Return value**

*String*: PEM private key or error information

**Example**

```javascript
var cert = get_certificate('artik')
console.log(get_key_from_cert(cert))
```

## get_certificate_sn

```javascript
Buffer get_certificate_sn(String cert_id)
```

**Description**

Return the serial number extracted from the device certificate
stored in the Secure Element. It is returned as a buffer of bytes.

**Parameters**

*String*: Certificate identifier. Must be **artik** or **manufacturer**

**Return value**

*Buffer*: serial number

**Example**

```javascript
console.log(get_certificate_sn('artik'))
```

## get_random_bytes

```javascript
Buffer get_random_bytes(Number length)
```

**Description**

Return a buffer of N bytes generated by the Secure Element.

**Parameters**

*Number*: length in bytes of the random buffer to generate.

**Return value**

*Buffer*: generated random bytes.

**Example**

```javascript
console.log(get_random_bytes(64))
```
## verify_signature_init

```javascript
verify_signature_init(String signature, String root_ca, Date signing_time, function(Number err, String reason, Date signing_time))
```

**Description**

Initialize a verification session for checking PKCS7 signature against a signed
binary.

**Parameters**

 - *String*: PKCS7 signature in PEM format
 - *String*: Root CA certificate in PEM format
 - *Date*: Signing time of the previous update package. If *Undefined* is provided
instead, no rollback detection will be performed
 - *function(Integer err, String reason, Date signing_time)*: callback function that
will be called after performing the initialization, and return result. If the function
was successful *err* will contain 0 otherwise an error code and *reason* will contain
details about the error. *signing_time* returns the signing time extracted from
the PKCS7 signature passed in parameters.

**Return value**

None.

## verify_signature_update

```javascript
verify_signature_update(Buffer data, function(Number err, String reason))
```

**Description**

Feed the verification session with data from the signed binary to check
against the PKCS7 signature. This function must be called by iterations
to feed the full content of the binary data.

**Parameters**

 - *Buffer*: buffer containing next portion of data from the signed binary
 - *function(Integer err, String reason)*: function called after processing
the data, returning the result of the operation. If the function was successful
*err* contains 0, if an error occured an error code is passed to *err* and
details can be found in the *reason* string.

**Return value**

None.

## verify_signature_final

```javascript
verify_signature_update(function(Number err, String reason))
```

**Description**

Finalize the verification session and return result.

**Parameters**

 - *function(Integer err, String reason)*: function called after performing
final verification, returning the result of the operation. If the function was
successful *err* contains 0, if an error occured an error code is passed to *err*
and details can be found in the *reason* string.

**Return value**

None.

## pkcs7_sig_verify

```javascript
pkcs7_sig_verify(String signature_file, String root_ca_file, String signed_file, String cert_id, Date signing_date, function(Object result))
```

**Description**

Perform signature verification of a binary against its PKCS7 signature.

**Parameters**

 - *String*: path to the file containing the PKCS7 signature in PEM format
 - *String*: path to the file containing the root CA file in PEM format
 - *String*: ID of the certificate from the Secure Element to use as the root CA.
 Accepted values are *'artik'*, *'manufacturer'*, or *''* (empty string) to use *root_ca_file*.
 - *Date*: signing date of the previous applied update package, used for rollback detection.
 - *function(Object result)*: object containing result information as described below:

```javascript
var result = {
    /* True if an error occured, False if verification is successful */
    error: Boolean,
    /* Details about the error */
    reason: String,
    /* Error code */
    error_code: Number,
    /* Signing time extracted from the PKCS7 signature */
    signing_time: Date,
}
```

*error_code* can be one of the following:

| Error code | Reason                          |
|:-----------|:-------------------------------:|
| 0          | success                         |
| -1         | invalid parameters              |
| -2         | invalid X509 certificate        |
| -3         | invalid PKCS7 signature         |
| -4         | CA verification failed          |
| -5         | computed digest mismatch        |
| -6         | signature verification failed   |
| -7         | signing time rollback detected  |

**Return value**

None.

**Examples**

* See [pkcs7-sig-verify.js](/examples/pkcs7-sig-verify.js)

